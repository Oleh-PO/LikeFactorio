<!DOCTYPE html>
<html>
<head>
	<title>LikeFactorio</title>
</head>
<body>
<canvas id="map" width="1920" height="975"></canvas>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style type="text/css">
	body {
		margin: 0;
	}
</style>
<script>
var map = document.getElementById("map")
var ctx = map.getContext("2d");
var block = 50;
var x = 0;
var y = 0;
var RayX = 0;
var RayY = 0;
var arc = 90;
var l = 0;
var lF = 0;
var length;
var degry = 1;
var offset = 0;
var rotation = 0;
var monitor;
var circleF = {
	coordinateX : 200,
	coordinateY : 200,
};
var mapX = 0;
var mapY = 0;
var map = {
	0 : ["#","#","#","#","#","#","#","#","#","#","#","#","#","#"],
	1 : ["#","_","_","_","_","_","#","_","_","_","_","_","_","#"],
	2 : ["#","_","_","#","#","_","#","#","#","#","#","#","_","#"],
	3 : ["#","_","#","#","_","_","_","_","_","_","_","#","_","#"],
	4 : ["#","_","_","_","_","_","#","#","_","#","_","_","_","#"],
	5 : ["#","#","#","#","#","#","#","#","#","#","#","#","#","#"],
};
var circle = function(color, x, y, radius) {
	ctx.beginPath();
	ctx.strokeStyle = color;
	ctx.fillStyle = color;
	ctx.arc(x, y, radius, 0, Math.PI*2, true);
	ctx.fill();
	ctx.stroke();
};
var render = function() {
	x = 0;
	y = 0;
	for (var i = 0; i < 6 * map[0].length; i++) {
		if (map[y][x] === "#") {
			ctx.fillStyle = "Black";
			ctx.fillRect(x * block, y * block, block, block);
			ctx.fillStyle = "Red";
			ctx.fillRect(0, 0, 10, 10);
		};
		if (x === map[0].length - 1) {
			y++
			x = 0;
		} else{
			x++;
		};
	};
};

$("#map").click(function(event) {
	// console.log((event.pageX) + "X|Y" + (event.pageY));
	// console.log(offset);
});
var rayCastF = function (xRF, xF, yRF, yF) {
	x = xF;
	y = yF;
	ctx.lineTo((circleF.coordinateX + xF), (circleF.coordinateY + yF));
	for (var o = 0; o < 300; o++) {
		mapY = Math.floor((circleF.coordinateY + yRF + y) / block);
		mapX = Math.floor((circleF.coordinateX + xRF + x) / block);
		if ((map[mapY])[mapX] === "#") {
			monitor = 1920 / 90;
			length = Math.sqrt(Math.pow(x , 2) + Math.pow(y, 2)) / 100;
			if (length < 1.6) {
				ctx.fillStyle = "#61666A";
			} else if (length < 2.6) {
				ctx.fillStyle = "#55595d";
			} else {
			ctx.fillStyle = "#3c4042";
			};
			if(offset === 0){
				ctx.fillRect(monitor * l, 450 - ((150 / length) / 2), monitor, 150 / length);
			} else if (offset === 1) {
				ctx.fillRect(monitor * (l + (90 - lF)), 450 - ((150 / length) / 2), monitor, 150 / length);
			} else if (offset === 2) {
				ctx.fillRect(monitor * l, 450 - ((150 / length) / 2), monitor, 150 / length);
			};
		};
		if ((map[mapY])[mapX] === "_") {
			ctx.lineTo((circleF.coordinateX + xRF + x), (circleF.coordinateY + yRF + y));
			x = x + xRF;
			y = y + yRF;
		};
	};
};
var floorRender = function() {
	ctx.fillStyle = "DarkGray";
	ctx.fillRect(0, 450, 1920, 550);
};
var rayCast = function() {
	ctx.lineWidth = 2;
	l = 0;
	// offset = 0;
	// console.log(Math.floor(rotation / arc));
	offset = Math.floor(rotation / arc);
	lF = rotation - offset * arc;
	for (var i = 0; i < arc / degry; i++) {
		// console.log(l + lF);
		switch(offset) {
		case 0 :
			y = Math.sqrt(Math.pow(block / 5 , 2) / (1 + Math.pow(Math.tan((l + lF) * Math.PI / 180), 2)));
			x = Math.sqrt((block/5)*(block/5) - (y * y));
			ctx.beginPath();
			ctx.moveTo(circleF.coordinateX, circleF.coordinateY);
			RayY = Math.sqrt(Math.pow(1, 2) / (1 + Math.pow(Math.tan((l + lF) * Math.PI / 180), 2)));
			RayX = Math.sqrt(Math.pow(1, 2) - Math.pow(RayY, 2));
			ctx.strokeStyle = "Red";
			rayCastF(RayX, x, RayY, y);
			break;
		 case 1 :
		 if (rotation < 90) {
				y = Math.sqrt(Math.pow(block / 5 , 2) / (1 + Math.pow(Math.tan((l) * Math.PI / 180), 2)));
				x = Math.sqrt((block/5)*(block/5) - (y * y));
				ctx.beginPath();
				ctx.moveTo(circleF.coordinateX, circleF.coordinateY);
				RayY = Math.sqrt(Math.pow(1, 2) / (1 + Math.pow(Math.tan((l) * Math.PI / 180), 2)));
				RayX = Math.sqrt(Math.pow(1, 2) - Math.pow(RayY, 2));
			} else {
				y = Math.sqrt(Math.pow(block / 5 , 2) / (1 + Math.pow(Math.tan((l + lF) * Math.PI / 180), 2)));
				x = Math.sqrt((block/5)*(block/5) - (y * y));
				ctx.beginPath();
				ctx.moveTo(circleF.coordinateX, circleF.coordinateY);
				RayY = Math.sqrt(Math.pow(1, 2) / (1 + Math.pow(Math.tan((l + lF) * Math.PI / 180), 2)));
				RayX = Math.sqrt(Math.pow(1, 2) - Math.pow(RayY, 2));
			};
			ctx.strokeStyle = "blue";
			rayCastF(RayY, y, -RayX, -x);
			break;
		case 2 :
			// console.log(1);
			// if (rotation < 180) {
				y = Math.sqrt(Math.pow(block / 5 , 2) / (1 + Math.pow(Math.tan((l) * Math.PI / 180), 2)));
				x = Math.sqrt((block/5)*(block/5) - (y * y));
				ctx.beginPath();
				ctx.moveTo(circleF.coordinateX, circleF.coordinateY);
				RayY = Math.sqrt(Math.pow(1, 2) / (1 + Math.pow(Math.tan((l) * Math.PI / 180), 2)));
				RayX = Math.sqrt(Math.pow(1, 2) - Math.pow(RayY, 2));
			// } else {
				// y = Math.sqrt(Math.pow(block / 5 , 2) / (1 + Math.pow(Math.tan((l + lF) * Math.PI / 180), 2)));
				// x = Math.sqrt((block/5)*(block/5) - (y * y));
				// ctx.beginPath();
				// ctx.moveTo(circleF.coordinateX, circleF.coordinateY);
				// RayY = Math.sqrt(Math.pow(1, 2) / (1 + Math.pow(Math.tan((l + lF) * Math.PI / 180), 2)));
				// RayX = Math.sqrt(Math.pow(1, 2) - Math.pow(RayY, 2));
			// };
			ctx.strokeStyle = "green";
			rayCastF(-RayX, -x, -RayY, -y);
			break;
		case 3 :
			ctx.strokeStyle = "yellow";
			rayCastF(-RayY, -y, RayX, x);
			break;
		};
		ctx.stroke();
		l = l + degry;
		// console.log(offset);
		// console.log(l);
		if (l + lF >= 90 && offset === 0) {
			l = 0;
			offset++;
		};
		if (l + lF >= 170 && offset === 1) {
			// console.log(true);
			l = 0;
			offset++;
		};
		if (l + lF >= 170 && offset === 0) {
			// console.log(true);
			l = 0;
			offset++;
		};
	};
};
$("body").keydown(function(event) { //keybord detector33
	// console.log(event.keyCode);
	// console.log(offset);
	// console.log(l + lF);
	y = Math.floor(Math.sqrt(10 / (1 + Math.pow(Math.tan((45 + rotation) * Math.PI / 180), 2))));
	x = Math.sqrt((10) - Math.pow(Math.floor(Math.sqrt(10 / (1 + Math.pow(Math.tan((45) * Math.PI / 180), 2)))),2));
	switch(event.keyCode){
		case 83:
			// circleF.coordinateY = circleF.coordinateY + 10;
			if (rotation >= 0 && rotation < 45){
				circleF.coordinateY = circleF.coordinateY - y;
				circleF.coordinateX = circleF.coordinateX - x;
			} else if (rotation >= 45) {
				circleF.coordinateY = circleF.coordinateY + y;
				circleF.coordinateX = circleF.coordinateX - x;
			};
			break;
		case 87:
			// circleF.coordinateY = circleF.coordinateY - 10;
			if (rotation >= 0 && rotation < 45){
				circleF.coordinateY = circleF.coordinateY + y;
				circleF.coordinateX = circleF.coordinateX + x;
			} else if (rotation >= 45){
				// console.log(true);
				circleF.coordinateY = circleF.coordinateY - y;
				circleF.coordinateX = circleF.coordinateX + x;
			};
			break;
		case 49:
			offset = 0;
			break;
		case 50:
			offset = 1;
			break;
		case 51:
			offset = 2;
			break;
		case 52:
			offset = 3;
			break;
		case 65: 
			// lF--;
			rotation--;
			break;
		case 68:
			rotation++;
			// lF++;
			break
	};
});
 setInterval(function() {
 	ctx.clearRect(0, 0, 2000, 1000);
	render();
	circle("#61666A", circleF.coordinateX, circleF.coordinateY, block/5);
	floorRender();
	rayCast();
},100)
 // setInterval(function(){
 // 	lF++;
 // }, 100);
</script>
</body>
</html>